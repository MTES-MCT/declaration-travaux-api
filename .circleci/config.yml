version: 2.1
executors:
  jdk8:
    docker:
      - image: circleci/openjdk:8u212-jdk-stretch
    working_directory: '~/rieau-api'
  jdk8integration:
    docker:
      - image: circleci/openjdk:8u212-jdk-stretch
      - image: circleci/postgres:10-alpine-ram
        environment:
          POSTGRES_PASS: postgres
          POSTGRES_DB: postgres
    working_directory: '~/rieau-api'

jobs:
  install-dependencies:
    executor: jdk8
    steps:
      - checkout
      - run: cp src/main/resources/application.properties.sample src/main/resources/application.properties
      - run: cp src/test/resources/application-staging.properties.sample src/test/resources/application-staging.properties
      - restore_cache:
          key: rieau-api-{{ checksum "pom.xml" }}
      - run: mvn dependency:go-offline
      - save_cache:
          paths:
            - '~/.m2'
          key: rieau-api-{{ checksum "pom.xml" }}
      - persist_to_workspace:
          root: '~'
          paths: 
            - '.m2'
            - 'rieau-api'
  check-dependencies:
    executor: jdk8
    steps:
      - attach_workspace:
          at: '~/'
      - run: mvn verify -DskipTests
      - store_test_results:
          path: target
  unit-tests:
    executor: jdk8
    steps:
      - attach_workspace:
          at: '~/'
      - run: mvn test
      - store_test_results:
          path: target/surefire-reports
  integration-tests:
    executor: jdk8integration
    steps:
      - attach_workspace:
          at: '~/'
      - run:
          name: Waiting for Postgres to be ready
          command: |
            for i in `seq 1 10`;
            do
              nc -z localhost 5432 && echo Success && exit 0
              echo -n .
              sleep 1
            done
            echo Failed waiting for Postgres && exit 1
      - run:
          name: Install PgSQL CLI; Init database
          environment:
            POSTGRES_USER: postgres
            POSTGRES_DB: postgres
          command: |
            sudo apt-get update
            sudo apt-get install -y postgresql-client
            psql -h localhost -p 5432 --username $POSTGRES_USER --dbname $POSTGRES_DB -c "CREATE USER rieau;"
            psql -h localhost -p 5432 --username $POSTGRES_USER --dbname $POSTGRES_DB -c "CREATE DATABASE rieau;"
            psql -h localhost -p 5432 --username $POSTGRES_USER --dbname $POSTGRES_DB -c "GRANT ALL PRIVILEGES ON DATABASE rieau TO rieau;"
      - run:
          command: |
            mvn test -Dspring.profiles.active=staging
      - store_test_results:
          path: target/surefire-reports
      
  build:
    executor: jdk8
    steps:
      - attach_workspace:
          at: '~/'
      - run:
          command: |
            mvn package -DskipTests -Dspring.profiles.active=staging  
      - store_artifacts:
          path: target/rieau-api-$CIRCLE_BUILD_NUM.jar
      - persist_to_workspace:
          root: '~'
          paths:
            - 'rieau-api'

  build-docker:
    executor: jdk8    
    steps:
      - attach_workspace:
          at: '~/rieau-api'
      - setup_remote_docker
      - run: |
          if [[ -z "$DOCKERHUB_USER" || -z "$DOCKERHUB_PASSWORD" ]]; then
            echo "Missing DOCKERHUB_USER or DOCKERHUB_PASSWORD environment variables!"
            exit 1
          fi
          docker build -t tristanrobert/rieau-api:$CIRCLE_SHA1 -f src/main/docker/Dockerfile .
          echo "$DOCKERHUB_PASSWORD" | docker login -u $DOCKERHUB_USER --password-stdin
          docker push tristanrobert/rieau-api:$CIRCLE_SHA1
          if [[ "$CIRCLE_BRANCH" = "master" ]]; then
            docker tag tristanrobert/rieau-api:$CIRCLE_SHA1 tristanrobert/rieau-api:latest
            docker push tristanrobert/rieau-api:latest
          fi

workflows:
  version: 2
  build-deploy:
    jobs:
      - install-dependencies:
          requires: []

      - check-dependencies:
          requires:
            - install-dependencies
      - unit-tests:
          requires:
            - install-dependencies
      - integration-tests:
          requires:
            - install-dependencies

      - build:
          requires:
            - unit-tests
            - integration-tests

      - build-docker:
          requires:
            - build
  weekly-dependency-check:
    triggers:
      - schedule:
          cron: "0 0 * * 0" # every sunday midnight
          filters:
            branches:
              only:
                - master
    jobs:
      - install-dependencies:
          requires: []
      - check-dependencies:
          requires:
            - install-dependencies
